{
   "name":{{cluster.name}},
   "description":{{cluster.description}},
   "vxnet":{{cluster.vxnet}},
   "backup_policy": "device",
   "incremental_backup_supported": true,
   "multi_zone_policy": "round_robin",
   "advanced_actions": ["change_vxnet", "scale_horizontal"],
   "upgrade_policy": [
        "appv-omli6gvn",
        "appv-xhnpehuq",
        "appv-20u3ybdq"
    ],
   "nodes":[
      {
         "role":"replica",
         "container":{
            "type":"kvm",
            "zone":"pek3a",
            "image":"img-mqcwt5kv"
         },
         "instance_class":{{cluster.replica.instance_class}},
         "count":{{cluster.replica.count}},
         "cpu":{{cluster.replica.cpu}},
         "memory":{{cluster.replica.memory}},
         "volume":{
            "size":{{cluster.replica.volume_size}},
            "class":{{cluster.replica.volume_class}},
            "mount_point":"/data",
            "filesystem":"ext4"
         },
         "passphraseless":"ssh-rsa",
         "vertical_scaling_policy":"sequential",
         "services":{
            "backup": {
               "nodes_to_execute_on": 1,
               "order": 1
            },
            "init":{
               "post_start_service":true,
               "order":1,
               "cmd":"/opt/app/bin/MongoTrib.py init"
            },
            "start":{
               "cmd":"mkdir -p /data/mongodb /data/info /data/logs /data/caddy/logs /data/zabbix-agent/logs;/opt/app/bin/start-mongod-server.sh && /opt/app/bin/zabbix.sh start"
            },
            "stop":{
               "cmd":"systemctl stop zabbix-agent;/opt/app/bin/stop-mongod-server.sh"
            },
            "restart":{
               "cmd":"/opt/app/bin/restart-mongod-server.sh"
            },
            "scale_out":{
               "nodes_to_execute_on":1,
               "order":2,
               "cmd":"/opt/app/bin/MongoTrib.py reconfig"
            },
            "scale_in":{
               "nodes_to_execute_on":1,
               "order":3,
               "cmd":"/opt/app/bin/MongoTrib.py reconfig"
            },
            "destroy":{
               "nodes_to_execute_on":1,
               "order":2,
               "cmd":"/opt/app/bin/MongoTrib.py reconfig"
            },
            "copy_log": {
                "type": "custom",
                "cmd": "chown caddy:svc /data/caddy/logs/;/opt/app/bin/MongoTrib.py copy_log && echo finish",
                "timeout": 1800,
                "service_params": {
                    "copy_log": {{service_params.copy_log}}
                }
            },
            "stop_caddy":{
                "type": "custom",
                "cmd": "systemctl stop caddy && echo finish",
                "timeout": 1800
            },
            "clean_log": {
                "type": "custom",
                "cmd": "/opt/app/bin/MongoTrib.py clean_log",
                "timeout": 1800
            },
            "upgrade": {
                "cmd": "/opt/app/bin/iptables-op.sh ban && /opt/app/bin/Upgrade.py && /opt/app/bin/iptables-op.sh open",
                "post_start_service":false,
                "timeout": 86400
            }
         }
      }
   ],
   "env": {
      "user": {{env.user}},
      "passwd": {{env.passwd}},
      "zabbix.server.addr": {{env.zabbix.server.addr}},
      "zabbix.agent.port": {{env.zabbix.agent.port}},
      "zabbix.agent.enabled": {{env.zabbix.agent.enabled}},
      "caddy_user":{{env.caddy_user}},
      "caddy_password":{{env.caddy_password}},
      "maxConns": {{env.maxConns}},
      "oplogSize": {{env.oplogSize}},
      "port": {{env.port}},
      "cacheSizeUsage": {{env.cacheSizeUsage}}
   },
   "advanced_services": {
      "update_nodes_names": {
         "cmd": "/opt/mongodb/bin/mongo-trib.py get_nodes_names",
         "timeout": 10
      }
   },
   "endpoints": {
      "mongod": {
         "port": {{env.port}},
         "protocol": "TCP"
      }
   },
   "health_check":{
      "enable": true,
      "interval_sec": 60,
      "timeout_sec": 30,
      "action_timeout_sec": 30,
      "healthy_threshold": 2,
      "unhealthy_threshold": 2,
      "check_cmd": "/opt/app/bin/MongoTrib.py health_check",
      "action_cmd": "/opt/app/bin/MongoTrib.py tackle"
   },
   "display_tabs": {
      "Node Details": {
         "cmd": "/opt/app/bin/MongoTrib.py get_node_details",
         "timeout": 10,
         "description": ""
      },
      "Connection String": {
         "cmd": "/opt/app/bin/MongoTrib.py print_connection_string",
         "timeout": 10,
         "description": ""
      }
   },
   "monitor":{
      "enable":true,
      "cmd":"/opt/app/bin/MongoTrib.py monitor",
      "items":{
         "opcounters-query":{
            "unit":"times",
            "value_type":"int",
            "statistics_type":"delta",
            "scale_factor_when_display":1
         },
         "opcounters-update":{
            "unit":"times",
            "value_type":"int",
            "statistics_type":"delta",
            "scale_factor_when_display":1
         },
         "opcountersRepl-query":{
            "unit":"times",
            "value_type":"int",
            "statistics_type":"delta",
            "scale_factor_when_display":1
         },
         "opcounters-insert":{
            "unit":"times",
            "value_type":"int",
            "statistics_type":"delta",
            "scale_factor_when_display":1
         },
         "opcounters-total":{
            "unit":"times",
            "value_type":"int",
            "statistics_type":"delta",
            "scale_factor_when_display":1
         },
         "opcountersRepl-total":{
            "unit":"times",
            "value_type":"int",
            "statistics_type":"delta",
            "scale_factor_when_display":1
         },
         "opcountersRepl-delete":{
            "unit":"times",
            "value_type":"int",
            "statistics_type":"delta",
            "scale_factor_when_display":1
         },
         "connections":{
            "unit":"times",
            "value_type":"int",
            "statistics_type":"avg",
            "scale_factor_when_display":1
         },
         "opcountersRepl-insert":{
            "unit":"times",
            "value_type":"int",
            "statistics_type":"delta",
            "scale_factor_when_display":1
         },
         "opcountersRepl-update":{
            "unit":"times",
            "value_type":"int",
            "statistics_type":"delta",
            "scale_factor_when_display":1
         },
         "opcounters-delete":{
            "unit":"times",
            "value_type":"int",
            "statistics_type":"delta",
            "scale_factor_when_display":1
         }
      },
      "groups":{
         "opcountersRepl":[
            "opcountersRepl-insert",
            "opcountersRepl-query",
            "opcountersRepl-update",
            "opcountersRepl-delete"
         ],
         "opcounters":[
            "opcounters-insert",
            "opcounters-query",
            "opcounters-update",
            "opcounters-delete"
         ]
      },
      "display":[
         "opcounters",
         "opcountersRepl",
         "connections"
      ],
      "alarm":[
         "connections"
      ]
   }
}
